#!/bin/bash

WIDTH_SX=1280
HEIGHT_SX=720
LEFT_SX=0
TOP_SX=0
WIDTH_DX=1280
HEIGHT_DX=720
LEFT_DX=0
TOP_DX=0

VIEWPORT_CONFIG=~/.config/4hd/viewport
NVIDIA_SETTING_RC=~/.nvidia-settings-rc
LOCK=/tmp/viewport_lock

log()
{
	logger -s -t $(basename $0) "$1"
}

check_params()
{
	[ $# -ne 2 ] && { log "Wrong number of parameters"; exit 1; }
	[[ "${1^^}" != "SX" && "${1^^}" != "DX" ]] && { log "Parameter $1 is not valid"; exit 1; }
	expr $2 + 1 &>/dev/null
	[ $? -ne 0 ] && { log "Second parameter is not a number"; exit 1;}
	[[ $2 -lt 0 || $2 -gt 200 ]] && { log "Second parameter must be in range 0 - 200";exit 1; }
	SIDE=${1^^}
	HORIZ_OFFSET=$2
	log "[${SIDE}] Using horizontal_offset ${HORIZ_OFFSET}"
}

create_default_viewport()
{
	log "[${SIDE}] create default viewport config"
	mkdir -p $(dirname ${VIEWPORT_CONFIG})
	echo "WIDTH_SX="${WIDTH_SX} > ${VIEWPORT_CONFIG}
	echo "HEIGHT_SX="${HEIGHT_SX} >> ${VIEWPORT_CONFIG}
	echo "LEFT_SX="${LEFT_SX}>> ${VIEWPORT_CONFIG}
	echo "TOP_SX="${TOP_SX} >> ${VIEWPORT_CONFIG}
	echo "WIDTH_DX="${WIDTH_DX} >> ${VIEWPORT_CONFIG}
	echo "HEIGHT_DX="${HEIGHT_DX} >> ${VIEWPORT_CONFIG}
	echo "LEFT_DX="${LEFT_DX} >> ${VIEWPORT_CONFIG}
	echo "TOP_DX="${TOP_DX} >> ${VIEWPORT_CONFIG}	
}

reset_mms()
{
	wget -q http://127.0.0.1:8769/recovery/sx -O /dev/null
	wget -q http://127.0.0.1:8769/recovery/dx -O /dev/null
	log "[${SIDE}] restarting mms..."
}

set_viewport()
{
	WIDTH=1280
	HEIGHT=720
	X_FACTOR=16
	Y_FACTOR=9

	NORM_HORIZ_OFFSET=$(((((${HORIZ_OFFSET} % ${X_FACTOR} + 8) / ${X_FACTOR}) + (${HORIZ_OFFSET} / ${X_FACTOR}))* ${X_FACTOR}))
	log "[${SIDE}] Using normalized horizontal_offset ${NORM_HORIZ_OFFSET} instead of ${HORIZ_OFFSET}"

	NEW_WIDTH=$((${WIDTH} - ${NORM_HORIZ_OFFSET}))
	NEW_HEIGHT=$((${NEW_WIDTH} * ${Y_FACTOR} / ${X_FACTOR}))
	NEW_LEFT=$((${NORM_HORIZ_OFFSET} / 2))
	NORM_VERT_OFFSET=$((${HEIGHT} - ${NEW_HEIGHT}))
	NEW_TOP=$((${NORM_VERT_OFFSET} / 2))

	if [ ! -f ${VIEWPORT_CONFIG} ]; then
		create_default_viewport
	fi

	sed 's/WIDTH_'${SIDE}'.*/WIDTH_'${SIDE}'='${NEW_WIDTH}'/' ${VIEWPORT_CONFIG} -i
	sed 's/HEIGHT_'${SIDE}'.*/HEIGHT_'${SIDE}'='${NEW_HEIGHT}'/' ${VIEWPORT_CONFIG} -i
	sed 's/LEFT_'${SIDE}'.*/LEFT_'${SIDE}'='${NEW_LEFT}'/' ${VIEWPORT_CONFIG} -i
	sed 's/TOP_'${SIDE}'.*/TOP_'${SIDE}'='${NEW_TOP}'/' ${VIEWPORT_CONFIG} -i

	WIDTH_SX=$(grep WIDTH_SX ${VIEWPORT_CONFIG} | awk 'BEGIN { FS = "=" }; {print $2}')
	HEIGHT_SX=$(grep HEIGHT_SX ${VIEWPORT_CONFIG} | awk 'BEGIN { FS = "=" }; {print $2}')
	LEFT_SX=$(grep LEFT_SX ${VIEWPORT_CONFIG} | awk 'BEGIN { FS = "=" }; {print $2}')
	TOP_SX=$(grep TOP_SX ${VIEWPORT_CONFIG} | awk 'BEGIN { FS = "=" }; {print $2}')
	WIDTH_DX=$(grep WIDTH_DX ${VIEWPORT_CONFIG} | awk 'BEGIN { FS = "=" }; {print $2}')
	HEIGHT_DX=$(grep HEIGHT_DX ${VIEWPORT_CONFIG} | awk 'BEGIN { FS = "=" }; {print $2}')
	LEFT_DX=$(grep LEFT_DX ${VIEWPORT_CONFIG} | awk 'BEGIN { FS = "=" }; {print $2}')
	TOP_DX=$(grep TOP_DX ${VIEWPORT_CONFIG} | awk 'BEGIN { FS = "=" }; {print $2}')

	VIEWPORT="0/CurrentMetaMode=DFP-0: 1280x720 +0+0 { ViewPortIn=1280x720, ViewPortOut=${WIDTH_SX}x${HEIGHT_SX}+${LEFT_SX}+${TOP_SX} }, DFP-1: 1280x720 +1280+0 { ViewPortIn=1280x720, ViewPortOut=${WIDTH_DX}x${HEIGHT_DX}+${LEFT_DX}+${TOP_DX} }"

	echo ${VIEWPORT} > ${NVIDIA_SETTING_RC}
	DISPLAY=:0 nvidia-settings --load-config-only &>/dev/null
	
	X_DISPLAY_RESOLUTION=$(QUERY_RES=`DISPLAY=:0 xdpyinfo | grep dimensions`; echo ${QUERY_RES:14})
	log "[${SIDE}] viewport is updated! X display resolution is now: ${X_DISPLAY_RESOLUTION}"
}

lock()
{
	local ok=0
	for ((counter=0;counter<5;counter++))
	do
		if ( set -o noclobber; echo "locked" > ${LOCK} ) 2>/dev/null
		then
			trap 'rm -f ${LOCK} ; log "[${SIDE}] Ending"' INT TERM EXIT
			log "[${SIDE}] lock..."
            ok=1
            break
		else
			ra=$RANDOM
            interval=$(x=$(expr $ra % 2);x=$(expr $x + 1); echo $x)
            log "[${SIDE}] Cannot lock file...sleeping for $interval secs"
            sleep $interval
		fi
	done        
	[ $ok -eq 0 ] && log "[${SIDE}] Unable to get lock!" && exit 1
}

unlock()
{
	rm ${LOCK} && log "[${SIDE}] ...unlock"
}

check_params $@
lock
set_viewport
unlock
